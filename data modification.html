      <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Data modification
</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="SqlCommandProvider provides statically typed access to input parameters and result set of T-SQL command in idiomatic F# way. SqlProgrammabilityProvider exposes Stored Procedures, User-Defined Types and User-Defined Functions in F# code.">
    <meta name="author" content="Dmitry Morozov, Dmitry Sevastianov">

    <script src="//code.jquery.com/jquery-1.8.0.js"></script>
    <script src="//code.jquery.com/ui/1.8.23/jquery-ui.js"></script>
    <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/js/bootstrap.min.js"></script>
    <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap-combined.min.css" rel="stylesheet" />

    <link type="text/css" rel="stylesheet" href="./content/style.css" />
    <script type="text/javascript" src="./content/tips.js"></script>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>
<body>
    <div class="container">
        <div class="masthead">
            <ul class="nav nav-pills pull-right">
                <li><a href="http://fsharp.org">fsharp.org</a></li>
                <li><a href="http://fsprojects.github.io/">fsprojects</a></li>
                <li><a href="http://github.com/fsprojects/FSharp.Data.SqlClient">github page</a></li>
            </ul>
            <h3 class="muted">FSharp.Data.SqlClient</h3>
        </div>
        <hr />
        <div class="row">
            <div class="span9" id="main">
                
<h1>Data modification</h1>

<p>FSharp.Data.SqlClient supports multiple approaches to send data modifications to Sql Server.</p>

<h2>Hand-written DML statements</h2>

<p>Write DML statements using <code>SqlCommandProvider</code>:</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">type</span> <span class="i">CurrencyCode</span> <span class="o">=</span> 
    <span class="i">SqlEnumProvider</span><span class="o">&lt;</span><span class="s">&quot;</span><span class="s">SELECT</span><span class="s"> </span><span class="s">Name</span><span class="s">,</span><span class="s"> </span><span class="s">CurrencyCode</span><span class="s"> </span><span class="s">FROM</span><span class="s"> </span><span class="s">Sales</span><span class="s">.</span><span class="s">Currency</span><span class="s">&quot;</span>, <span class="i">connectionString</span><span class="o">&gt;</span>

<span class="k">do</span>
    <span class="k">use</span> <span class="i">cmd</span> <span class="o">=</span> <span class="k">new</span> <span class="i">SqlCommandProvider</span><span class="o">&lt;</span><span class="s">&quot;</span>
<span class="s">        </span><span class="s">INSERT</span><span class="s"> </span><span class="s">INTO</span><span class="s"> </span><span class="s">Sales</span><span class="s">.</span><span class="s">CurrencyRate</span><span class="s"> </span>
<span class="s">        </span><span class="s">VALUES</span><span class="s"> </span><span class="s">(</span><span class="s">@</span><span class="s">currencyRateDate</span><span class="s">,</span><span class="s"> </span><span class="s">@</span><span class="s">fromCurrencyCode</span><span class="s">,</span><span class="s"> </span><span class="s">@</span><span class="s">toCurrencyCode</span><span class="s">,</span><span class="s"> </span>
<span class="s">                </span><span class="s">@</span><span class="s">averageRate</span><span class="s">,</span><span class="s"> </span><span class="s">@</span><span class="s">endOfDayRate</span><span class="s">,</span><span class="s"> </span><span class="s">DEFAULT</span><span class="s">)</span><span class="s"> </span>
<span class="s">    </span><span class="s">&quot;</span>, <span class="i">connectionString</span><span class="o">&gt;</span>(<span class="i">connectionString</span>)

    <span class="k">let</span> <span class="i">recordsInserted</span> <span class="o">=</span> 
        <span class="i">cmd</span><span class="o">.</span><span class="i">Execute</span>(
            <span class="i">currencyRateDate</span> <span class="o">=</span> <span class="i">DateTime</span><span class="o">.</span><span class="i">Today</span>, 
            <span class="i">fromCurrencyCode</span> <span class="o">=</span> <span class="i">CurrencyCode</span><span class="o">.</span><span class="i">``US Dollar``</span>, 
            <span class="i">toCurrencyCode</span> <span class="o">=</span> <span class="i">CurrencyCode</span><span class="o">.</span><span class="i">``United Kingdom Pound``</span>, 
            <span class="i">averageRate</span> <span class="o">=</span> <span class="n">0.63219M</span>, 
            <span class="i">endOfDayRate</span> <span class="o">=</span> <span class="n">0.63219M</span>) 

    <span class="k">assert</span> (<span class="i">recordsInserted</span> <span class="o">=</span> <span class="n">1</span>)</pre>
</td>
</tr>
</table>

<p>This works for any kind of data modification statement: <em>INSERT</em>, <em>UPDATE</em>, <em>DELETE</em>, <em>MERGE</em> etc.</p>

<h2>Stored Procedures</h2>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
<span class="l">26: </span>
<span class="l">27: </span>
<span class="l">28: </span>
<span class="l">29: </span>
<span class="l">30: </span>
<span class="l">31: </span>
<span class="l">32: </span>
<span class="l">33: </span>
<span class="l">34: </span>
<span class="l">35: </span>
<span class="l">36: </span>
<span class="l">37: </span>
<span class="l">38: </span>
<span class="l">39: </span>
<span class="l">40: </span>
<span class="l">41: </span>
<span class="l">42: </span>
<span class="l">43: </span>
<span class="l">44: </span>
<span class="l">45: </span>
<span class="l">46: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">type</span> <span class="i">AdventureWorks</span> <span class="o">=</span> <span class="i">SqlProgrammabilityProvider</span><span class="o">&lt;</span><span class="i">connectionString</span><span class="o">&gt;</span>

<span class="k">let</span> <span class="i">jamesKramerId</span> <span class="o">=</span> <span class="n">42</span>

<span class="k">let</span> <span class="i">businessEntityID</span>, <span class="i">jobTitle</span>, <span class="i">hireDate</span> <span class="o">=</span> 
    <span class="k">use</span> <span class="i">cmd</span> <span class="o">=</span> <span class="k">new</span> <span class="i">SqlCommandProvider</span><span class="o">&lt;</span><span class="s">&quot;</span>
<span class="s">        </span><span class="s">SELECT</span><span class="s"> </span>
<span class="s">	        </span><span class="s">BusinessEntityID</span>
<span class="s">	        </span><span class="s">,</span><span class="s">JobTitle</span>
<span class="s">	        </span><span class="s">,</span><span class="s">HireDate</span>
<span class="s">        </span><span class="s">FROM</span><span class="s"> </span>
<span class="s">            </span><span class="s">HumanResources</span><span class="s">.</span><span class="s">Employee</span><span class="s"> </span>
<span class="s">        </span><span class="s">WHERE</span><span class="s"> </span>
<span class="s">            </span><span class="s">BusinessEntityID</span><span class="s"> </span><span class="s">=</span><span class="s"> </span><span class="s">@</span><span class="s">id</span>
<span class="s">        </span><span class="s">&quot;</span>, <span class="i">connectionString</span>, <span class="i">ResultType</span><span class="o">.</span><span class="i">Tuples</span>, <span class="i">SingleRow</span> <span class="o">=</span> <span class="k">true</span><span class="o">&gt;</span>(<span class="i">connectionString</span>)

    <span class="i">jamesKramerId</span> <span class="o">|&gt;</span> <span class="i">cmd</span><span class="o">.</span><span class="i">Execute</span> <span class="o">|&gt;</span> <span class="i">Option</span><span class="o">.</span><span class="i">get</span>

<span class="k">assert</span>(<span class="s">&quot;</span><span class="s">Production</span><span class="s"> </span><span class="s">Technician</span><span class="s"> </span><span class="s">-</span><span class="s"> </span><span class="s">WC60</span><span class="s">&quot;</span> <span class="o">=</span> <span class="i">jobTitle</span>)
    
<span class="k">let</span> <span class="i">newJobTitle</span> <span class="o">=</span> <span class="s">&quot;</span><span class="s">Uber</span><span class="s"> </span><span class="s">&quot;</span> <span class="o">+</span> <span class="i">jobTitle</span>

<span class="k">let</span> <span class="i">recordsAffrected</span> <span class="o">=</span> 
    <span class="k">use</span> <span class="i">updatedJobTitle</span> <span class="o">=</span> <span class="k">new</span> <span class="i">AdventureWorks</span><span class="o">.</span><span class="i">HumanResources</span><span class="o">.</span><span class="i">uspUpdateEmployeeHireInfo</span>(<span class="i">connectionString</span>)
    <span class="i">updatedJobTitle</span><span class="o">.</span><span class="i">Execute</span>(
        <span class="i">businessEntityID</span>, 
        <span class="i">newJobTitle</span>, 
        <span class="i">hireDate</span>, 
        <span class="i">RateChangeDate</span> <span class="o">=</span> <span class="i">DateTime</span><span class="o">.</span><span class="i">Now</span>, 
        <span class="i">Rate</span> <span class="o">=</span> <span class="n">12M</span>, 
        <span class="i">PayFrequency</span> <span class="o">=</span> <span class="n">1uy</span>, 
        <span class="i">CurrentFlag</span> <span class="o">=</span> <span class="k">true</span> 
    )

<span class="k">assert</span>(<span class="i">recordsAffrected</span> <span class="o">=</span> <span class="n">1</span>)

<span class="k">let</span> <span class="i">updatedJobTitle</span> <span class="o">=</span> 
    <span class="c">// Static Create factory method provides better IntelliSense than ctor.</span>
    <span class="c">// See https://github.com/Microsoft/visualfsharp/issues/449</span>
    <span class="k">use</span> <span class="i">cmd</span> <span class="o">=</span> <span class="k">new</span> <span class="i">AdventureWorks</span><span class="o">.</span><span class="i">dbo</span><span class="o">.</span><span class="i">ufnGetContactInformation</span>(<span class="i">connectionString</span>)

    <span class="c">//Use ExecuteSingle if you&#39;re sure it return 0 or 1 rows.</span>
    <span class="k">let</span> <span class="i">result</span> <span class="o">=</span> <span class="i">cmd</span><span class="o">.</span><span class="i">ExecuteSingle</span>(<span class="i">PersonID</span> <span class="o">=</span> <span class="i">jamesKramerId</span>) 
    <span class="i">result</span><span class="o">.</span><span class="i">Value</span><span class="o">.</span><span class="i">JobTitle</span><span class="o">.</span><span class="i">Value</span>

<span class="k">assert</span>(<span class="i">newJobTitle</span> <span class="o">=</span> <span class="i">updatedJobTitle</span>)</pre>
</td>
</tr>
</table>

<h2>Statically-typed DataTable</h2>

<p>Both hand-written T-SQL and stored procedures have a significant downside: it requires tedious coding. 
It gets worse when different kinds of modifications -- inserts, updates, deletes, merges -- need to be issued for the same entity.
In most cases you are forced to have one command/stored procedure per modification type. 
<code>SqlProgrammabilityProvider</code> offers an elegant solution based on the ADO.NET <a href="https://msdn.microsoft.com/en-us/library/system.data.datatable.aspx">DataTable</a> 
class with static types on top. 
To a certain extent, this is similar to the ancient, almost forgotten <a href="https://msdn.microsoft.com/en-us/library/wha85tzb.aspx">Generating Strongly Typed DataSets</a> 
technique except that the epic F# <a href="https://msdn.microsoft.com/en-us/library/hh156509.aspx">Type Providers</a> feature
streamlines the whole development experience.</p>

<p>Using <code>Sales.CurrencyRate</code> table as an example, let's see how a generated table type is different from its base <a href="https://msdn.microsoft.com/en-us/library/system.data.datatable.aspx">DataTable</a> type.</p>

<p>Generated table type names follow a consistent pattern: <em>TypeAliasForRoot</em>.<em>SchemaName</em>.<em>Tables</em>.<em>TableName</em></p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
<span class="l">2: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">let</span> <span class="i">currencyRates</span> <span class="o">=</span> <span class="k">new</span> <span class="i">AdventureWorks</span><span class="o">.</span><span class="i">Sales</span><span class="o">.</span><span class="i">Tables</span><span class="o">.</span><span class="i">CurrencyRate</span>()
<span class="k">assert</span> (<span class="i">currencyRates</span><span class="o">.</span><span class="i">TableName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="s">[</span><span class="s">Sales</span><span class="s">]</span><span class="s">.</span><span class="s">[</span><span class="s">CurrencyRate</span><span class="s">]</span><span class="s">&quot;</span>)</pre>
</td>
</tr>
</table>

<p>The type provider generates an expected value for the <code>TableName</code> property.</p>

<p>The <code>Rows</code> property, of type <code>IList&lt;#DataRow&gt;</code>, provides access to the rows within the table.
Familiar list operations are available for typed DataTable: Add, Remove, Insert etc.
Typed column accessors are added to the existing set of <code>DataRow</code> type members. 
The IntelliSense experience is left a little clunky to retain legacy <code>DataRow</code> type members.</p>

<img src="img/DataRowTypedAccessors.png"/>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
<span class="l">2: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">let</span> <span class="i">firstRow</span> <span class="o">=</span> <span class="i">currencyRates</span><span class="o">.</span><span class="i">Rows</span><span class="o">.</span>[<span class="n">0</span>]
<span class="i">firstRow</span><span class="o">.</span><span class="i">AverageRate</span></pre>
</td>
</tr>
</table>

<p>It is possible to get a reference to the DataColumn object</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">let</span> <span class="i">averageRateColumn</span> <span class="o">=</span> <span class="i">currencyRates</span><span class="o">.</span><span class="i">Columns</span><span class="o">.</span><span class="i">AverageRate</span></pre>
</td>
</tr>
</table>

<p>The <code>AddRow</code> method adds a new row to a table.</p>

<img src="img/AddRow.png"/>

<ul>
<li>There is 1-1 correspondence between column names/types and the method parameters</li>
<li><code>IDENTITY</code> column is excluded from parameters list for obvious reasons</li>
<li>Nullable columns are mappend to parameters of type <code>option&lt;_&gt;</code></li>
<li>Columns with <code>DEFAULT</code> constraint are also represented as parameters of type <code>option&lt;_&gt;</code>. 
This is more convenient that specifying DEFAULT as a value in INSERT statement</li>
<li>Both kinds of parameters -- nullable columns or columns with defaults -- can be omitted from invocation</li>
<li>Minor but nice feature is the ability to retrieve <code>MS_Description</code>, which works only for Sql Server 
because Sql Azure doesn't support extended properties.</li>
</ul>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
<span class="l">7: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">do</span>
    <span class="i">currencyRates</span><span class="o">.</span><span class="i">AddRow</span>(
        <span class="i">CurrencyRateDate</span> <span class="o">=</span> <span class="i">DateTime</span><span class="o">.</span><span class="i">Today</span>, 
        <span class="i">FromCurrencyCode</span> <span class="o">=</span> <span class="i">CurrencyCode</span><span class="o">.</span><span class="i">``US Dollar``</span>, 
        <span class="i">ToCurrencyCode</span> <span class="o">=</span> <span class="i">CurrencyCode</span><span class="o">.</span><span class="i">``United Kingdom Pound``</span>, 
        <span class="i">AverageRate</span> <span class="o">=</span> <span class="n">0.63219M</span>, 
        <span class="i">EndOfDayRate</span> <span class="o">=</span> <span class="n">0.63219M</span>)</pre>
</td>
</tr>
</table>

<p>Side-effecting <code>AddRow</code> makes it easier to add rows in type-safe manner. 
A pair of invocations to <code>NewRow</code> and <code>Rows.Add</code> can be used as an alternative. 
This approach also makes sense if for some reason you need to keep a reference to a newly added row for further manipulations.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">do</span> 
    <span class="k">let</span> <span class="i">newRow</span> <span class="o">=</span> 
        <span class="i">currencyRates</span><span class="o">.</span><span class="i">NewRow</span>(
            <span class="i">CurrencyRateDate</span> <span class="o">=</span> <span class="i">DateTime</span><span class="o">.</span><span class="i">Today</span>, 
            <span class="i">FromCurrencyCode</span> <span class="o">=</span> <span class="i">CurrencyCode</span><span class="o">.</span><span class="i">``US Dollar``</span>, 
            <span class="i">ToCurrencyCode</span> <span class="o">=</span> <span class="i">CurrencyCode</span><span class="o">.</span><span class="i">``United Kingdom Pound``</span>, 
            <span class="i">AverageRate</span> <span class="o">=</span> <span class="n">0.63219M</span>, 
            <span class="i">EndOfDayRate</span> <span class="o">=</span> <span class="n">0.63219M</span>,
            <span class="c">//Column with DEFAULT constraint can be passed in explicitly</span>
            <span class="i">ModifiedDate</span> <span class="o">=</span> <span class="i">Some</span> <span class="i">DateTime</span><span class="o">.</span><span class="i">Today</span>
        )
    <span class="i">currencyRates</span><span class="o">.</span><span class="i">Rows</span><span class="o">.</span><span class="i">Add</span> <span class="i">newRow</span></pre>
</td>
</tr>
</table>

<p>With this knowledge in mind, the example at top the page can be re-written as follows:</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">do</span>
    <span class="k">let</span> <span class="i">currencyRates</span> <span class="o">=</span> <span class="k">new</span> <span class="i">AdventureWorks</span><span class="o">.</span><span class="i">Sales</span><span class="o">.</span><span class="i">Tables</span><span class="o">.</span><span class="i">CurrencyRate</span>()
    <span class="k">let</span> <span class="i">newRow</span> <span class="o">=</span> 
        <span class="i">currencyRates</span><span class="o">.</span><span class="i">NewRow</span>(
            <span class="i">CurrencyRateDate</span> <span class="o">=</span> <span class="i">DateTime</span><span class="o">.</span><span class="i">Today</span>, 
            <span class="i">FromCurrencyCode</span> <span class="o">=</span> <span class="s">&quot;</span><span class="s">USD</span><span class="s">&quot;</span>, 
            <span class="i">ToCurrencyCode</span> <span class="o">=</span> <span class="s">&quot;</span><span class="s">GBP</span><span class="s">&quot;</span>, 
            <span class="i">AverageRate</span> <span class="o">=</span> <span class="n">0.63219M</span>, 
            <span class="i">EndOfDayRate</span> <span class="o">=</span> <span class="n">0.63219M</span>
        )
    <span class="i">currencyRates</span><span class="o">.</span><span class="i">Rows</span><span class="o">.</span><span class="i">Add</span> <span class="i">newRow</span>
    <span class="c">//Call Update to push changes to a database</span>
    <span class="k">let</span> <span class="i">recordsAffected</span> <span class="o">=</span> <span class="i">currencyRates</span><span class="o">.</span><span class="i">Update</span>()
    <span class="k">assert</span>(<span class="i">recordsAffected</span> <span class="o">=</span> <span class="n">1</span>)
    <span class="i">printfn</span> <span class="s">&quot;</span><span class="s">ID</span><span class="s">:</span><span class="s"> </span><span class="s">%</span><span class="s">i</span><span class="s">,</span><span class="s"> </span><span class="s">ModifiedDate</span><span class="s">:</span><span class="s"> </span><span class="s">%</span><span class="s">O</span><span class="s">&quot;</span> <span class="i">newRow</span><span class="o">.</span><span class="i">CurrencyRateID</span> <span class="i">newRow</span><span class="o">.</span><span class="i">ModifiedDate</span></pre>
</td>
</tr>
</table>

<ul>
<li>Call to <code>Update</code> is required to push changes into a database</li>
<li><code>CurrencyRateID</code> IDENTITY column and all fields with DEFAULT constraints that didn't have value specified are 
refreshed after an update from the database. This is a very cool feature. <strong>It works only for <code>BatchSize</code> = 1</strong>, which is the default.
Of course it's applicable only to new data rows (that issue an INSERT statement).
Follow <a href="https://msdn.microsoft.com/en-us/library/aadf8fk2.aspx">this link</a> to find out more about batch updates.</li>
</ul>

<p>The snippet below demonstrates update and delete logic. 
Note how combining <code>SqlCommandProvider</code> to load existing data with typed data tables produces simple and safe code.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
<span class="l">26: </span>
<span class="l">27: </span>
<span class="l">28: </span>
<span class="l">29: </span>
<span class="l">30: </span>
<span class="l">31: </span>
<span class="l">32: </span>
<span class="l">33: </span>
<span class="l">34: </span>
<span class="l">35: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">do</span>
    <span class="k">use</span> <span class="i">cmd</span> <span class="o">=</span> <span class="k">new</span> <span class="i">SqlCommandProvider</span><span class="o">&lt;</span><span class="s">&quot;</span>
<span class="s">        </span><span class="s">SELECT</span><span class="s"> </span><span class="s">*</span><span class="s"> </span>
<span class="s">        </span><span class="s">FROM</span><span class="s"> </span><span class="s">Sales</span><span class="s">.</span><span class="s">CurrencyRate</span><span class="s"> </span>
<span class="s">        </span><span class="s">WHERE</span><span class="s"> </span><span class="s">FromCurrencyCode</span><span class="s"> </span><span class="s">=</span><span class="s"> </span><span class="s">@</span><span class="s">from</span>
<span class="s">            </span><span class="s">AND</span><span class="s"> </span><span class="s">ToCurrencyCode</span><span class="s"> </span><span class="s">=</span><span class="s"> </span><span class="s">@</span><span class="s">to</span>
<span class="s">            </span><span class="s">AND</span><span class="s"> </span><span class="s">CurrencyRateDate</span><span class="s"> </span><span class="s">&gt;</span><span class="s"> </span><span class="s">@</span><span class="s">date</span>
<span class="s">        </span><span class="s">&quot;</span>, <span class="i">connectionString</span>, <span class="i">ResultType</span><span class="o">.</span><span class="i">DataReader</span><span class="o">&gt;</span>(<span class="i">connectionString</span>)
    <span class="c">//ResultType.DataReader !!!</span>
    <span class="k">let</span> <span class="i">currencyRates</span> <span class="o">=</span> <span class="k">new</span> <span class="i">AdventureWorks</span><span class="o">.</span><span class="i">Sales</span><span class="o">.</span><span class="i">Tables</span><span class="o">.</span><span class="i">CurrencyRate</span>()
    <span class="c">//load data into data table</span>
    <span class="i">cmd</span><span class="o">.</span><span class="i">Execute</span>(<span class="s">&quot;</span><span class="s">USD</span><span class="s">&quot;</span>, <span class="s">&quot;</span><span class="s">GBP</span><span class="s">&quot;</span>, <span class="i">DateTime</span>(<span class="n">2014</span>, <span class="n">1</span>, <span class="n">1</span>)) <span class="o">|&gt;</span> <span class="i">currencyRates</span><span class="o">.</span><span class="i">Load</span>

    <span class="k">let</span> <span class="i">latestModification</span> <span class="o">=</span>
        <span class="c">//manipulate Rows as a sequence</span>
        <span class="i">currencyRates</span><span class="o">.</span><span class="i">Rows</span>
        <span class="o">|&gt;</span> <span class="i">Seq</span><span class="o">.</span><span class="i">sortBy</span> (<span class="k">fun</span> <span class="i">x</span> <span class="k">-&gt;</span> <span class="i">x</span><span class="o">.</span><span class="i">ModifiedDate</span>)
        <span class="o">|&gt;</span> <span class="i">Seq</span><span class="o">.</span><span class="i">last</span>

    <span class="i">latestModification</span><span class="o">.</span><span class="i">Delete</span>()
    <span class="c">//or use list operation</span>
    <span class="c">//currencyRates.Rows.Remove latestModification</span>

    <span class="c">//adjust rates slightly</span>
    <span class="k">for</span> <span class="i">row</span> <span class="k">in</span> <span class="i">currencyRates</span><span class="o">.</span><span class="i">Rows</span> <span class="k">do</span>
        <span class="k">if</span> <span class="i">row</span><span class="o">.</span><span class="i">RowState</span> <span class="o">&lt;&gt;</span> <span class="i">System</span><span class="o">.</span><span class="i">Data</span><span class="o">.</span><span class="i">DataRowState</span><span class="o">.</span><span class="i">Deleted</span>
        <span class="k">then</span> 
            <span class="i">row</span><span class="o">.</span><span class="i">EndOfDayRate</span> <span class="o">&lt;-</span> <span class="i">row</span><span class="o">.</span><span class="i">EndOfDayRate</span> <span class="o">+</span> <span class="n">0.01M</span>
            <span class="i">row</span><span class="o">.</span><span class="i">ModifiedDate</span> <span class="o">&lt;-</span> <span class="i">DateTime</span><span class="o">.</span><span class="i">Today</span>

    <span class="k">let</span> <span class="i">totalRecords</span> <span class="o">=</span> <span class="i">currencyRates</span><span class="o">.</span><span class="i">Rows</span><span class="o">.</span><span class="i">Count</span>
    <span class="c">// custom batch size - send them all at once</span>
    <span class="k">let</span> <span class="i">recordsAffected</span> <span class="o">=</span> <span class="i">currencyRates</span><span class="o">.</span><span class="i">Update</span>(<span class="i">batchSize</span> <span class="o">=</span> <span class="i">totalRecords</span>) 
    
    <span class="k">assert</span> (<span class="i">recordsAffected</span> <span class="o">=</span> <span class="i">totalRecords</span>)</pre>
</td>
</tr>
</table>

<div class="well well-small" style="margin:0px 70px 0px 20px;">

<p><strong>WARNING</strong> Unfortunately, the <code>Update</code> method on the typed data table doesn't have an asynchronous version. 
Command types provided by SqlCommandProvider have distinct advantage when you need asynchronous invocation.</p>

</p></div>

<h2>Bulk Load</h2>

<p>Bulk loading is another useful scenario for typed data tables. 
It looks exactly like adding new rows except at the end you make a call to <code>BulkCopy</code> instead of <code>Update</code>.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">do</span>
    <span class="k">let</span> <span class="i">currencyRates</span> <span class="o">=</span> <span class="k">new</span> <span class="i">AdventureWorks</span><span class="o">.</span><span class="i">Sales</span><span class="o">.</span><span class="i">Tables</span><span class="o">.</span><span class="i">CurrencyRate</span>()
    <span class="k">let</span> <span class="i">newRow</span> <span class="o">=</span> 
        <span class="i">currencyRates</span><span class="o">.</span><span class="i">NewRow</span>(
            <span class="i">CurrencyRateDate</span> <span class="o">=</span> <span class="i">DateTime</span><span class="o">.</span><span class="i">Today</span>, 
            <span class="i">FromCurrencyCode</span> <span class="o">=</span> <span class="s">&quot;</span><span class="s">USD</span><span class="s">&quot;</span>, 
            <span class="i">ToCurrencyCode</span> <span class="o">=</span> <span class="s">&quot;</span><span class="s">GBP</span><span class="s">&quot;</span>, 
            <span class="i">AverageRate</span> <span class="o">=</span> <span class="n">0.63219M</span>, 
            <span class="i">EndOfDayRate</span> <span class="o">=</span> <span class="n">0.63219M</span>,
            <span class="i">ModifiedDate</span> <span class="o">=</span> <span class="i">DateTime</span><span class="o">.</span><span class="i">Today</span>
        )

    <span class="i">currencyRates</span><span class="o">.</span><span class="i">Rows</span><span class="o">.</span><span class="i">Add</span> <span class="i">newRow</span>
    <span class="c">//Insert many more rows here</span>
    <span class="i">currencyRates</span><span class="o">.</span><span class="i">BulkCopy</span>(<span class="i">copyOptions</span> <span class="o">=</span> <span class="i">System</span><span class="o">.</span><span class="i">Data</span><span class="o">.</span><span class="i">SqlClient</span><span class="o">.</span><span class="i">SqlBulkCopyOptions</span><span class="o">.</span><span class="i">TableLock</span>)</pre>
</td>
</tr>
</table>

<h2>Custom update/bulk copy logic</h2>

<p>Both <code>Update</code> and <code>BulkCopy</code> operations can be configured via parameters, i.e. connection, transaction, batchSize, etc.
That said, default update logic provided by typed DataTable can be insufficient for some advanced scenarios. 
You don't need to give up on convenience of static typing, however. You can also 
customize update behavior by creating your own instance of <a href="https://msdn.microsoft.com/en-us/library/system.data.sqlclient.sqldataadapter.aspx">SqlDataAdapter</a> 
(or <a href="https://msdn.microsoft.com/en-us/library/system.data.sqlclient.sqlbulkcopy.aspx">SqlBulkCopy</a>) and configuring it to your needs.</p>

<p>Pseudocode for custom data adapter:</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">open</span> <span class="i">System</span><span class="o">.</span><span class="i">Data</span><span class="o">.</span><span class="i">SqlClient</span>

<span class="k">do</span>
    <span class="k">let</span> <span class="i">currencyRates</span> <span class="o">=</span> <span class="k">new</span> <span class="i">AdventureWorks</span><span class="o">.</span><span class="i">Sales</span><span class="o">.</span><span class="i">Tables</span><span class="o">.</span><span class="i">CurrencyRate</span>()
    <span class="c">//load, update, delete, insert rows </span>
    <span class="c">// ...</span>
    <span class="k">use</span> <span class="i">adapter</span> <span class="o">=</span> <span class="k">new</span> <span class="i">SqlDataAdapter</span>()
    <span class="c">//configure adapter: setup select, insert, update, delete commands, transaction etc.</span>
    <span class="c">// ...</span>
    <span class="i">adapter</span><span class="o">.</span><span class="i">Update</span>( <span class="i">currencyRates</span>) <span class="o">|&gt;</span> <span class="i">ignore</span>

<span class="c">//Similarly for custom bulk copy:</span>
    
<span class="k">do</span>
    <span class="k">let</span> <span class="i">currencyRates</span> <span class="o">=</span> <span class="k">new</span> <span class="i">AdventureWorks</span><span class="o">.</span><span class="i">Sales</span><span class="o">.</span><span class="i">Tables</span><span class="o">.</span><span class="i">CurrencyRate</span>()
    <span class="c">//load, update, delete, insert rows </span>
    <span class="c">// ...</span>
    <span class="c">//configure bulkCopy: copyOptions, connectoin, transaction, timeout, batch size etc.</span>
    <span class="k">use</span> <span class="i">bulkCopy</span> <span class="o">=</span> <span class="k">new</span> <span class="i">SqlBulkCopy</span>(<span class="i">AdventureWorks</span><span class="o">.</span><span class="i">Sales</span><span class="o">.</span><span class="i">Tables</span><span class="o">.</span><span class="i">CurrencyRate</span><span class="o">.</span><span class="i">ConnectionStringOrName</span>)
    <span class="c">// ...</span>
    <span class="i">bulkCopy</span><span class="o">.</span><span class="i">WriteToServer</span>( <span class="i">currencyRates</span>) <span class="o">|&gt;</span> <span class="i">ignore</span></pre>
</td>
</tr>
</table>

<h2>Transaction and connection management</h2>

<p>Please read <a href="transactions.html">Transactions</a> chapter of the documentation.
Pay particular attention to <em>DataTable Updates/Bulk Load</em> section.</p>

<h2>Query-derived tables</h2>

<p>You can get your hands on a typed data table by specifying ResultType.DataTable as the output type 
for <code>SqlCommandProvider</code> generated command types. 
This approach gives flexibility at a cost of leaving more room for error. 
An output projection should be suitable for sending changes back to a database. 
It rules out transformations, extensive joins etc. 
Only raw columns for a single table make good candidates for persistable changes. 
The typed <code>DataTable</code> class you get back by executing a command with <code>ResultType.DataTable</code> is largely similar to the one 
describe above. One noticeable difference is the absence of the parametrized <code>AddRow</code>/<code>NewRow</code> method. This is intentional. 
Updating, deleting or merging rows are the most likely scenarios where this can be useful. 
For update/delete/merge logic to work properly, primary key (or unique index) columns must be included 
in column selection. To insert new records, use static data table types generated by <code>SqlProgrammbilityProvider</code>. 
That said, it's still possible to add rows with some static typing support.</p>

<p>One of the examples above can be re-written as</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
<span class="l">26: </span>
<span class="l">27: </span>
<span class="l">28: </span>
<span class="l">29: </span>
<span class="l">30: </span>
<span class="l">31: </span>
<span class="l">32: </span>
<span class="l">33: </span>
<span class="l">34: </span>
<span class="l">35: </span>
<span class="l">36: </span>
<span class="l">37: </span>
<span class="l">38: </span>
<span class="l">39: </span>
<span class="l">40: </span>
<span class="l">41: </span>
<span class="l">42: </span>
<span class="l">43: </span>
<span class="l">44: </span>
<span class="l">45: </span>
<span class="l">46: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">do</span>
    <span class="c">//CurrencyRateID is included</span>
    <span class="k">use</span> <span class="i">cmd</span> <span class="o">=</span> <span class="k">new</span> <span class="i">SqlCommandProvider</span><span class="o">&lt;</span><span class="s">&quot;</span>
<span class="s">        </span><span class="s">SELECT</span><span class="s"> </span>
<span class="s">            </span><span class="s">CurrencyRateID</span><span class="s">,</span>
<span class="s">            </span><span class="s">CurrencyRateDate</span><span class="s">,</span>
<span class="s">            </span><span class="s">FromCurrencyCode</span><span class="s">,</span>
<span class="s">            </span><span class="s">ToCurrencyCode</span><span class="s">,</span>
<span class="s">            </span><span class="s">AverageRate</span><span class="s">,</span>
<span class="s">            </span><span class="s">EndOfDayRate</span>
<span class="s">        </span><span class="s">FROM</span><span class="s"> </span><span class="s">Sales</span><span class="s">.</span><span class="s">CurrencyRate</span><span class="s"> </span>
<span class="s">        </span><span class="s">WHERE</span><span class="s"> </span><span class="s">FromCurrencyCode</span><span class="s"> </span><span class="s">=</span><span class="s"> </span><span class="s">@</span><span class="s">from</span>
<span class="s">            </span><span class="s">AND</span><span class="s"> </span><span class="s">ToCurrencyCode</span><span class="s"> </span><span class="s">=</span><span class="s"> </span><span class="s">@</span><span class="s">to</span>
<span class="s">            </span><span class="s">AND</span><span class="s"> </span><span class="s">CurrencyRateDate</span><span class="s"> </span><span class="s">&gt;</span><span class="s"> </span><span class="s">@</span><span class="s">date</span>
<span class="s">        </span><span class="s">&quot;</span>, <span class="i">connectionString</span>, <span class="i">ResultType</span><span class="o">.</span><span class="i">DataTable</span><span class="o">&gt;</span>(<span class="i">connectionString</span>)
    <span class="c">//ResultType.DataTable !!!</span>
    <span class="k">let</span> <span class="i">currencyRates</span> <span class="o">=</span> <span class="i">cmd</span><span class="o">.</span><span class="i">Execute</span>(<span class="s">&quot;</span><span class="s">USD</span><span class="s">&quot;</span>, <span class="s">&quot;</span><span class="s">GBP</span><span class="s">&quot;</span>, <span class="i">DateTime</span>(<span class="n">2014</span>, <span class="n">1</span>, <span class="n">1</span>)) 

    <span class="k">let</span> <span class="i">latestModification</span> <span class="o">=</span>
        <span class="i">currencyRates</span><span class="o">.</span><span class="i">Rows</span>
        <span class="o">|&gt;</span> <span class="i">Seq</span><span class="o">.</span><span class="i">sortBy</span> (<span class="k">fun</span> <span class="i">x</span> <span class="k">-&gt;</span> <span class="i">x</span><span class="o">.</span><span class="i">CurrencyRateDate</span>)
        <span class="o">|&gt;</span> <span class="i">Seq</span><span class="o">.</span><span class="i">last</span>
    
    <span class="c">//Delete</span>
    <span class="i">latestModification</span><span class="o">.</span><span class="i">Delete</span>()

    <span class="c">//Update</span>
    <span class="k">for</span> <span class="i">row</span> <span class="k">in</span> <span class="i">currencyRates</span><span class="o">.</span><span class="i">Rows</span> <span class="k">do</span>
        <span class="k">if</span> <span class="i">row</span><span class="o">.</span><span class="i">RowState</span> <span class="o">&lt;&gt;</span> <span class="i">System</span><span class="o">.</span><span class="i">Data</span><span class="o">.</span><span class="i">DataRowState</span><span class="o">.</span><span class="i">Deleted</span>
        <span class="k">then</span> 
            <span class="i">row</span><span class="o">.</span><span class="i">EndOfDayRate</span> <span class="o">&lt;-</span> <span class="i">row</span><span class="o">.</span><span class="i">EndOfDayRate</span> <span class="o">+</span> <span class="n">0.01M</span>

    <span class="c">//Insert</span>
    <span class="k">let</span> <span class="i">newRecord</span> <span class="o">=</span> <span class="i">currencyRates</span><span class="o">.</span><span class="i">NewRow</span>()
    <span class="i">newRecord</span><span class="o">.</span><span class="i">CurrencyRateDate</span> <span class="o">&lt;-</span> <span class="i">DateTime</span><span class="o">.</span><span class="i">Today</span>
    <span class="i">newRecord</span><span class="o">.</span><span class="i">FromCurrencyCode</span> <span class="o">&lt;-</span> <span class="s">&quot;</span><span class="s">USD</span><span class="s">&quot;</span>
    <span class="i">newRecord</span><span class="o">.</span><span class="i">ToCurrencyCode</span> <span class="o">&lt;-</span> <span class="s">&quot;</span><span class="s">GBP</span><span class="s">&quot;</span>
    <span class="i">newRecord</span><span class="o">.</span><span class="i">AverageRate</span> <span class="o">&lt;-</span> <span class="n">0.63219M</span>
    <span class="i">newRecord</span><span class="o">.</span><span class="i">EndOfDayRate</span> <span class="o">&lt;-</span> <span class="n">0.63219M</span>

    <span class="i">currencyRates</span><span class="o">.</span><span class="i">Rows</span><span class="o">.</span><span class="i">Add</span> <span class="i">newRecord</span>

    <span class="k">let</span> <span class="i">totalRecords</span> <span class="o">=</span> <span class="i">currencyRates</span><span class="o">.</span><span class="i">Rows</span><span class="o">.</span><span class="i">Count</span>

    <span class="k">let</span> <span class="i">recordsAffected</span> <span class="o">=</span> <span class="i">currencyRates</span><span class="o">.</span><span class="i">Update</span>(<span class="i">batchSize</span> <span class="o">=</span> <span class="i">totalRecords</span>) 
    <span class="k">assert</span> (<span class="i">recordsAffected</span> <span class="o">=</span> <span class="i">totalRecords</span>)</pre>
</td>
</tr>
</table>


            </div>

            <div class="span3">
                <a href="http://www.nuget.org/packages/FSharp.Data.SqlClient">
                    <img src="img/logo.png" style="width: 200px; height: 200px; margin: 10px 0px 0px 35px; border-style: none;" />
                </a>
                <ul class="nav nav-list" id="menu">
                    <li class="nav-header">F# SqlClient</li>
                    <li><a href="./index.html">Home page</a></li>
                    <li class="divider"></li>
                    <li><a href="http://www.nuget.org/packages/FSharp.Data.SqlClient">Get Library via NuGet</a></li>
                    <li><a href="http://github.com/fsprojects/FSharp.Data.SqlClient">Source Code on GitHub</a></li>
                    <li><a href="http://github.com/fsprojects/FSharp.Data.SqlClient/blob/master/LICENSE.md">License</a></li>
                    <li><a href="http://github.com/fsprojects/FSharp.Data.SqlClient/blob/master/RELEASE_NOTES.md">Release Notes</a></li>

                    <li class="nav-header">Documentation</li>
                    <li><a href="./whatsnew.html">What's New</a></li>
                    <li><a href="./configuration and input.html">Configuration and Input</a></li>
                    <li><a href="./output.html">Output</a></li>
                    <li><a href="./faq.html">FAQ</a></li>
                    <li class="divider"></li>
                    <li><a href="./data modification.html">Data Modification</a></li>
                    <li><a href="./transactions.html">Transactions</a></li>
                    <li class="divider"></li>
                    <li><a href="./debugging.html">Debugging</a></li>
                    <li><a href="./unit-testing.html">Unit Testing</a></li>
                    <li class="divider"></li>
                    <li><a href="./comparison.html">Comparison</a></li>
                    <li><a href="./dynamic local db.html">Dynamic local db</a></li>
                    <li class="divider"></li>
                    <li><a href="./sqlenumprovider.quickstart.html">SqlEnumProvider</a></li>

                    <li class="nav-header">Tools</li>
                    <li><a href="http://tpetricek.github.io/FSharp.Formatting/">F# Formatting</a></li>
                    <li><a href="http://fsharp.github.io/FAKE/">FAKE</a></li>
                    <li><a href="http://fsprojects.github.io/ProjectScaffold/">F# open-source project scaffolding</a></li>
                    <li><a href="http://tomasp.net/blog/2013/great-open-source/index.html">Building great open-source libraries</a></li>
                </ul>
            </div>
        </div>
    </div>
    <a href="http://github.com/fsprojects/FSharp.Data.SqlClient">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub">
    </a>
</body>
</html>
