      <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Debugging
</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="SqlCommandProvider provides statically typed access to input parameters and result set of T-SQL command in idiomatic F# way. SqlProgrammabilityProvider exposes Stored Procedures, User-Defined Types and User-Defined Functions in F# code.">
    <meta name="author" content="Dmitry Morozov, Dmitry Sevastianov">

    <script src="//code.jquery.com/jquery-1.8.0.js"></script>
    <script src="//code.jquery.com/ui/1.8.23/jquery-ui.js"></script>
    <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/js/bootstrap.min.js"></script>
    <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap-combined.min.css" rel="stylesheet" />

    <link type="text/css" rel="stylesheet" href="./content/style.css" />
    <script type="text/javascript" src="./content/tips.js"></script>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>
<body>
    <div class="container">
        <div class="masthead">
            <ul class="nav nav-pills pull-right">
                <li><a href="http://fsharp.org">fsharp.org</a></li>
                <li><a href="http://fsprojects.github.io/">fsprojects</a></li>
                <li><a href="http://github.com/fsprojects/FSharp.Data.SqlClient">github page</a></li>
            </ul>
            <h3 class="muted">FSharp.Data.SqlClient</h3>
        </div>
        <hr />
        <div class="row">
            <div class="span9" id="main">
                
<h1>Debugging</h1>

<p>Following FSharp.Data.SqlClient specific techniques can be used to diagnose various issues.</p>

<h2>ToTraceString</h2>

<p>Call ToTraceString to get text representation of sql statement that will be executed in Sql Server</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
<span class="l">7: </span>
<span class="l">8: </span>
<span class="l">9: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs1', 1)" onmouseover="showTip(event, 'fs1', 1)" class="i">cmd</span> <span class="o">=</span> <span class="k">new</span> <span class="i">SqlCommandProvider</span><span class="o">&lt;</span><span class="s">&quot;</span>
<span class="s">    </span><span class="s">SELECT</span><span class="s"> </span><span class="s">TOP</span><span class="s">(</span><span class="s">@</span><span class="s">topN</span><span class="s">)</span><span class="s"> </span><span class="s">FirstName</span><span class="s">,</span><span class="s"> </span><span class="s">LastName</span><span class="s">,</span><span class="s"> </span><span class="s">SalesYTD</span><span class="s"> </span>
<span class="s">    </span><span class="s">FROM</span><span class="s"> </span><span class="s">Sales</span><span class="s">.</span><span class="s">vSalesPerson</span>
<span class="s">    </span><span class="s">WHERE</span><span class="s"> </span><span class="s">CountryRegionName</span><span class="s"> </span><span class="s">=</span><span class="s"> </span><span class="s">@</span><span class="s">regionName</span><span class="s"> </span><span class="s">AND</span><span class="s"> </span><span class="s">SalesYTD</span><span class="s"> </span><span class="s">&gt;</span><span class="s"> </span><span class="s">@</span><span class="s">salesMoreThan</span><span class="s"> </span>
<span class="s">    </span><span class="s">ORDER</span><span class="s"> </span><span class="s">BY</span><span class="s"> </span><span class="s">SalesYTD</span>
<span class="s">    </span><span class="s">&quot;</span> , <span onmouseout="hideTip(event, 'fs2', 2)" onmouseover="showTip(event, 'fs2', 2)" class="i">connectionString</span><span class="o">&gt;</span>(<span onmouseout="hideTip(event, 'fs2', 3)" onmouseover="showTip(event, 'fs2', 3)" class="i">connectionString</span>)

<span onmouseout="hideTip(event, 'fs1', 4)" onmouseover="showTip(event, 'fs1', 4)" class="i">cmd</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs3', 5)" onmouseover="showTip(event, 'fs3', 5)" class="i">ToTraceString</span>(<span class="i">topN</span> <span class="o">=</span> <span class="n">3L</span>, <span class="i">regionName</span> <span class="o">=</span> <span class="s">&quot;</span><span class="s">United</span><span class="s"> </span><span class="s">States</span><span class="s">&quot;</span>, <span class="i">salesMoreThan</span> <span class="o">=</span> <span class="n">1000000M</span>) 
<span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs4', 6)" onmouseover="showTip(event, 'fs4', 6)" class="i">printfn</span> <span class="s">&quot;</span><span class="s">Sql</span><span class="s">:</span><span class="s"> </span><span class="s">%</span><span class="s">s</span><span class="s">&quot;</span></pre>
</td>
</tr>
</table>

<h2>Direct access to underlying SqlCommand instance.</h2>

<p>If you feel that getting your hands on underlying ADO.NET SqlCommand can help to address a problem that can be done. 
Expect to see a warning because this is not intended for public use and subject for change. 
Avoid tempering state of this SqlCommand instance otherwise all bets are off.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs5', 7)" onmouseover="showTip(event, 'fs5', 7)" class="i">adonetCmd</span> <span class="o">=</span> (<span onmouseout="hideTip(event, 'fs1', 8)" onmouseover="showTip(event, 'fs1', 8)" class="i">cmd</span> <span class="o">:&gt;</span> <span class="i">ISqlCommand</span>)<span class="o">.</span><span class="i">Raw</span>

[ <span class="k">for</span> <span onmouseout="hideTip(event, 'fs6', 9)" onmouseover="showTip(event, 'fs6', 9)" class="i">p</span> <span class="k">in</span> <span onmouseout="hideTip(event, 'fs5', 10)" onmouseover="showTip(event, 'fs5', 10)" class="i">adonetCmd</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs7', 11)" onmouseover="showTip(event, 'fs7', 11)" class="i">Parameters</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs6', 12)" onmouseover="showTip(event, 'fs6', 12)" class="i">p</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs8', 13)" onmouseover="showTip(event, 'fs8', 13)" class="i">ParameterName</span>, <span onmouseout="hideTip(event, 'fs6', 14)" onmouseover="showTip(event, 'fs6', 14)" class="i">p</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs9', 15)" onmouseover="showTip(event, 'fs9', 15)" class="i">SqlDbType</span> ]
<span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs4', 16)" onmouseover="showTip(event, 'fs4', 16)" class="i">printfn</span> <span class="s">&quot;</span><span class="s">Inferred</span><span class="s"> </span><span class="s">parameters</span><span class="s">:</span><span class="s"> </span><span class="s">%</span><span class="s">A</span><span class="s">&quot;</span> </pre>
</td>
</tr>
</table>

<h2>Result set runtime verification.</h2>

<p>While enjoying all benefits of static types at design time one can easily end up in a situation 
when runtime Sql Server database schema is different from compile time. 
Up until now this resulted in confusion runtime exception: <code>InvalidCastException("Specified cast is not valid.")</code>.</p>

<p>To improve diagnostics without hurting performance a new global singleton configuration object is introduced. 
To access <code>Configuration</code> type open up <code>FSharp.Data.SqlClient</code> namespace.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
<span class="l">2: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span class="k">open</span> <span onmouseout="hideTip(event, 'fs10', 17)" onmouseover="showTip(event, 'fs10', 17)" class="i">FSharp</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs11', 18)" onmouseover="showTip(event, 'fs11', 18)" class="i">Data</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs12', 19)" onmouseover="showTip(event, 'fs12', 19)" class="i">SqlClient</span>
<span class="k">assert</span>(<span onmouseout="hideTip(event, 'fs13', 20)" onmouseover="showTip(event, 'fs13', 20)" class="i">Configuration</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs14', 21)" onmouseover="showTip(event, 'fs14', 21)" class="i">Current</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs15', 22)" onmouseover="showTip(event, 'fs15', 22)" class="i">ResultsetRuntimeVerification</span> <span class="o">=</span> <span class="k">false</span>) </pre>
</td>
</tr>
</table>

<p>So far it has only one property <code>ResultsetRuntimeVerification</code> which set to false by default.
Set it to true to see more descriptive error like:</p>

<p><code>InvalidOperationException(Expected column [Total] of type "System.Int32" at position 1 (0-based indexing) 
but received column [Now] of type "System.DateTime")</code>.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
<span onmouseout="hideTip(event, 'fs13', 23)" onmouseover="showTip(event, 'fs13', 23)" class="i">Configuration</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs14', 24)" onmouseover="showTip(event, 'fs14', 24)" class="i">Current</span> <span class="o">&lt;-</span> { <span onmouseout="hideTip(event, 'fs13', 25)" onmouseover="showTip(event, 'fs13', 25)" class="i">Configuration</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs14', 26)" onmouseover="showTip(event, 'fs14', 26)" class="i">Current</span> <span class="k">with</span> <span class="i">ResultsetRuntimeVerification</span> <span class="o">=</span> <span class="k">true</span> }</pre>
</td>
</tr>
</table>

<h2>Other debugging/instrumentation tools to consider:</h2>

<ul>
<li><a href="https://msdn.microsoft.com/en-us/library/ms181091.aspx">Sql Profiler</a></li>
<li><a href="https://msdn.microsoft.com/en-us/library/cc765421.aspx">ADO.NET tracing</a></li>
<li><a href="https://azure.microsoft.com/en-us/documentation/articles/sql-database-monitoring-with-dmvs/">Dynamic views</a></li>
<li><a href="https://azure.microsoft.com/en-us/blog/query-store-a-flight-data-recorder-for-your-database/">Query store</a></li>
</ul>

<div class="tip" id="fs1">val cmd : ISqlCommand<br /><br />Full name: Debugging.cmd</div>
<div class="tip" id="fs2">val connectionString : string<br /><br />Full name: Debugging.connectionString</div>
<div class="tip" id="fs3">abstract member ISqlCommand.ToTraceString : parameters:(string * obj) [] -&gt; string</div>
<div class="tip" id="fs4">val printfn : format:Printf.TextWriterFormat&lt;&#39;T&gt; -&gt; &#39;T<br /><br />Full name: Microsoft.FSharp.Core.ExtraTopLevelOperators.printfn</div>
<div class="tip" id="fs5">val adonetCmd : Data.SqlClient.SqlCommand<br /><br />Full name: Debugging.adonetCmd</div>
<div class="tip" id="fs6">val p : Data.SqlClient.SqlParameter</div>
<div class="tip" id="fs7">property Data.SqlClient.SqlCommand.Parameters: Data.SqlClient.SqlParameterCollection</div>
<div class="tip" id="fs8">property Data.SqlClient.SqlParameter.ParameterName: string</div>
<div class="tip" id="fs9">property Data.SqlClient.SqlParameter.SqlDbType: Data.SqlDbType</div>
<div class="tip" id="fs10">namespace FSharp</div>
<div class="tip" id="fs11">namespace FSharp.Data</div>
<div class="tip" id="fs12">namespace FSharp.Data.SqlClient</div>
<div class="tip" id="fs13">Multiple items<br />namespace System.Configuration<br /><br />--------------------<br />module Configuration<br /><br />from FSharp.Data<br /><br />--------------------<br />type Configuration =<br />&#160;&#160;{ResultsetRuntimeVerification: bool;}<br /><br />Full name: FSharp.Data.SqlClient.Configuration</div>
<div class="tip" id="fs14">property Configuration.Current: Configuration</div>
<div class="tip" id="fs15">Configuration.ResultsetRuntimeVerification: bool</div>

            </div>

            <div class="span3">
                <a href="http://www.nuget.org/packages/FSharp.Data.SqlClient">
                    <img src="img/logo.png" style="width: 200px; height: 200px; margin: 10px 0px 0px 35px; border-style: none;" />
                </a>
                <ul class="nav nav-list" id="menu">
                    <li class="nav-header">F# SqlClient</li>
                    <li><a href="./index.html">Home page</a></li>
                    <li class="divider"></li>
                    <li><a href="http://www.nuget.org/packages/FSharp.Data.SqlClient">Get Library via NuGet</a></li>
                    <li><a href="http://github.com/fsprojects/FSharp.Data.SqlClient">Source Code on GitHub</a></li>
                    <li><a href="http://github.com/fsprojects/FSharp.Data.SqlClient/blob/master/LICENSE.md">License</a></li>
                    <li><a href="http://github.com/fsprojects/FSharp.Data.SqlClient/blob/master/RELEASE_NOTES.md">Release Notes</a></li>

                    <li class="nav-header">Documentation</li>
                    <li><a href="./whatsnew.html">What's New</a></li>
                    <li><a href="./netcore.html">Support for .NET Core</a></li>
                    <li><a href="./configuration and input.html">Configuration and Input</a></li>
                    <li><a href="./output.html">Output</a></li>                    
                    <li><a href="./faq.html">FAQ</a></li>
                    <li class="divider"></li>
                    <li><a href="./data modification.html">Data Modification</a></li>
                    <li><a href="./transactions.html">Transactions</a></li>
                    <li class="divider"></li>
                    <li><a href="./debugging.html">Debugging</a></li>
                    <li><a href="./unit-testing.html">Unit Testing</a></li>
                    <li class="divider"></li>
                    <li><a href="./comparison.html">Comparison</a></li>
                    <li><a href="./dynamic local db.html">Dynamic local db</a></li>
                    <li class="divider"></li>
                    <li><a href="./sqlenumprovider.quickstart.html">SqlEnumProvider</a></li>

                    <li class="nav-header">Tools</li>
                    <li><a href="http://tpetricek.github.io/FSharp.Formatting/">F# Formatting</a></li>
                    <li><a href="http://fsharp.github.io/FAKE/">FAKE</a></li>
                    <li><a href="http://fsprojects.github.io/ProjectScaffold/">F# open-source project scaffolding</a></li>
                    <li><a href="http://tomasp.net/blog/2013/great-open-source/index.html">Building great open-source libraries</a></li>
                </ul>
            </div>
        </div>
    </div>
    <a href="http://github.com/fsprojects/FSharp.Data.SqlClient">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub">
    </a>
</body>
</html>
